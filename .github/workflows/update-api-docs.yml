name: Update Reference Documentation

on:
  workflow_dispatch:  # Allow manual triggers
    inputs:
      version:
        description: 'Version to generate docs for (e.g., "2.2.x", "2.1.x", "2.0.x") or "all" for all versions'
        required: true
        default: 'all'
        type: string
  release:  # Automatically trigger on new releases
    types: [published]

jobs:
  generate-api-docs:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout docs repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/kgateway.dev
          path: kgateway.dev

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Parse versions from hugo.yaml
        run: |
          cd kgateway.dev
          python3 -c "
          import yaml
          import json
          
          with open('hugo.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          versions = config.get('params', {}).get('versions', [])
          version_data = []
          
          for version in versions:
              version_info = {
                  'version': version.get('version'),
                  'linkVersion': version.get('linkVersion'),
                  'url': version.get('url', '').lstrip('/')
              }
              version_data.append(version_info)
          
          print(json.dumps(version_data))
          " > versions.json
          
          echo "Parsed versions:"
          cat versions.json

      - name: Read max Kubernetes version
        run: |
          KUBE_VERSION=$(cat kgateway.dev/assets/docs/versions/max-kube.md | tr -d '\n')
          echo "KUBE_VERSION=$KUBE_VERSION" >> $GITHUB_ENV

      - name: Generate all documentation for selected version(s)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ inputs.version }}
          KUBE_VERSION: ${{ env.KUBE_VERSION }}
        run: |
          cd kgateway.dev
          python3 scripts/generate-ref-docs.py


      - name: Clean up temporary directories
        run: |
          cd kgateway.dev
          rm -rf kgateway

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: kgateway.dev
          commit-message: "docs: Update API, Helm, and Metrics reference docs${{ github.event_name == 'release' && format(' for release {0}', github.event.release.tag_name) || format(' for {0}', inputs.version == 'all' && 'all versions' || inputs.version) }}"
          signoff: true
          title: "Update API, Helm, and Metrics reference docs${{ github.event_name == 'release' && format(' for release {0}', github.event.release.tag_name) || format(' for {0}', inputs.version == 'all' && 'all versions' || inputs.version) }}"
          body: |
            ${{ github.event_name == 'release' && format('üéâ **Automated documentation update for release {0}**', github.event.release.tag_name) || format('üìù **Manual documentation update for {0}**', inputs.version == 'all' && 'all supported versions' || format('version {0}', inputs.version)) }}
            
            This PR updates API, Helm, and Metrics reference documentation based on the latest tags from the **kgateway** repository.
            
            **Trigger:** ${{ github.event_name == 'release' && 'üöÄ Release published' || 'üë§ Manual workflow dispatch' }}
            ${{ github.event_name == 'release' && format('**Release:** `{0}`', github.event.release.tag_name) || format('**Target version:** `{0}`', inputs.version) }}
            
            **Updates included:**
            - API reference documentation 
            - Helm chart reference documentation
            - Control plane metrics documentation
            - Each version uses the latest corresponding tag from the kgateway repository
            
            **File locations:**
            - API docs: `content/docs/envoy/{VERSION}/reference/api.md`
            - Helm docs: `assets/docs/pages/reference/helm/{VERSION}/` (included in content pages via `reuse` shortcode)
            - Metrics docs: `assets/docs/snippets/{VERSION}/metrics-control-plane.md`
          branch: api-gen-update
          branch-suffix: timestamp
          delete-branch: true
          base: main
          labels: |
            documentation
            automated pr