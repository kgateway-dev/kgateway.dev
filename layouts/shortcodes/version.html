<!-- Get the current buildcondition from the config and lowercase it -->
{{- $url := .Page.RelPermalink -}}
{{- /* remove leading/trailing slashes */ -}}
{{- $trimmed := trim $url "/" -}}
{{- /* split by slash */ -}}
{{- $parts := split $trimmed "/" -}}
{{- $version := "" -}}

{{- /* Extract version from path: /docs/envoy/latest/... or /docs/agentgateway/latest/... or /docs/latest/... */ -}}
{{- if and (ge (len $parts) 2) (eq (index $parts 0) "docs") -}}
    {{- /* Check if we have a section (envoy/agentgateway) before the version */ -}}
    {{- if and (ge (len $parts) 3) (or (eq (index $parts 1) "envoy") (eq (index $parts 1) "agentgateway")) -}}
        {{- $version = index $parts 2 -}}
    {{- else -}}
        {{- /* Legacy path format: /docs/{version}/... */ -}}
        {{- $version = index $parts 1 -}}
    {{- end -}}
{{- end -}}

{{ $condition := $version }}

{{- if ne $condition "" -}}
    <!-- Get the parameters from the shortcode invocation and lowercase them.
    TODO: to enable multiple conditions, we could accept comma-separated lists and split them -->
    {{- $include := .Get "include-if" | default "" -}}
    {{- $include_if := split $include "," -}}
    {{- $exclude := .Get "exclude-if" | default "" -}}
    {{- $exclude_if := split $exclude "," -}}

{{- $shouldRender := false -}}
{{- $currentVersionToml := "" -}}

{{- /* First pass: determine if content should be rendered */ -}}
{{ range .Site.Params.versions }} 
 {{- if in $condition .linkVersion -}}
   {{- $versionToml := .version -}}
   {{- $currentVersionToml = $versionToml -}}
 
    {{- if and (in $include_if $versionToml ) (in $exclude_if $versionToml) -}}
        <!-- condition appears in both parameters -->
        {{- errorf "Build condition %q appears in both include-if and exclude-if parameters of conditional-txt shortcode on page %s" $condition .Position -}}
    {{- end -}}

    {{- if isset $.Params "include-if" -}}
        <!-- WARNING substring matches are matches as well! That means, if include-if="foobar", and buildcondition is "foo", you have a match!-->
        {{- if in $include_if $versionToml -}}
          {{- $shouldRender = true -}}
        {{- end -}}
    {{- else if isset $.Params "exclude-if" -}}
        <!-- WARNING substring matches are matches as well! That means, if exclude-if="foobar", and buildcondition is "foo", you have a match!-->
        {{- if not (in $exclude_if $versionToml) -}}
          {{- $shouldRender = true -}}
        {{- end -}}
    {{- else -}}
        {{- $shouldRender = true -}}
    {{- end -}}
 {{- end -}}
{{- end -}}

{{- /* Second pass: render content only once if conditions are met */ -}}
{{- if $shouldRender -}}
<!-- Do not indent the next Inner line, because the inner becomes a blockquote if the conditional-text is nested in another shortcode  -->
{{- $.Inner | $.Page.RenderString -}}
{{- end -}}

{{- end -}}
